generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id             String  @id @default(cuid())
  name           String
  domain         String? @unique
  domainVerified Boolean @default(false)
  settings       Json?

  // Branding
  brandingLogoUrl String?
  brandingColors  Json? // { primary: "#xxx", secondary: "#xxx" }

  // Trial
  trialActive Boolean   @default(true)
  trialEndsAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users        User[]
  userTenants  UserTenant[]
  teams        Team[]
  candidates   Candidate[]
  interviews   Interview[]
  feedbacks    Feedback[]
  apiKeys      APIKey[]
  integrations Integration[]
  auditLogs    AuditLog[]
  fileObjects  FileObject[]
  invitations  Invitation[]

  // Communication Module
  channelConfigs    ChannelConfig[]
  messageTemplates  MessageTemplate[]
  automationRules   AutomationRule[]
  messageLogs       MessageLog[]
  scheduledMessages ScheduledMessage[]

  // Calendar / Scheduling Module
  workingHours         WorkingHours[]
  busyBlocks           BusyBlock[]
  schedulingRules      SchedulingRule[]
  interviewSlots       InterviewSlot[]
  calendarSyncAccounts CalendarSyncAccount[]
  securityPolicy       TenantSecurityPolicy?
  
  // SSO / Identity Providers
  identityProviders    IdentityProvider[]
  
  // Hiring Pipeline
  hiringStages         HiringStage[]
  
  // External Feedback from ATS
  externalFeedbackContexts ExternalFeedbackContext[]
  // Custom Roles
  customRoles          CustomRole[]
  
  // Salesforce Opportunities (context, not candidates)
  opportunityContexts  OpportunityContext[]
}

// Tenant-configurable hiring stages for the recruitment pipeline
model HiringStage {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name      String   // Display name: "Screening"
  key       String   // Stable key: "SCREENING" (used in Candidate.stage)
  order     Int      // Pipeline order (1, 2, 3...)
  color     String?  // Optional UI color hex code
  
  isActive   Boolean  @default(true)
  isDefault  Boolean  @default(false) // Only one per tenant
  isTerminal Boolean  @default(false) // Terminal stages (HIRED, REJECTED) cannot be changed
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, key])
  @@index([tenantId, order])
  @@index([tenantId, isActive])
}

// Security policy per tenant for IP allowlist, password policies, etc.
model TenantSecurityPolicy {
  id       String @id @default(cuid())
  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // IP Allowlist
  ipAllowlistEnabled Boolean  @default(false)
  allowedIPs         String[] @default([])

  // Password Policy
  passwordMinLength       Int     @default(8)
  passwordRequireUppercase Boolean @default(true)
  passwordRequireLowercase Boolean @default(true)
  passwordRequireNumber    Boolean @default(true)
  passwordRequireSymbol    Boolean @default(true)
  passwordMaxAgeDays      Int?    // null = no expiry

  // Session Policy
  maxConcurrentSessions Int? // null = unlimited
  sessionTimeoutMinutes Int? // null = use default

  // Two-Factor Authentication
  enforce2FA          Boolean @default(false) // Require 2FA for all users
  enforce2FAForAdmins Boolean @default(false) // Require 2FA for admins only

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id       String     @id @default(cuid())
  tenantId String? // Legacy: kept for backward compatibility
  tenant   Tenant?    @relation(fields: [tenantId], references: [id])
  email    String     @unique
  password String
  name     String?
  role     Role       @default(RECRUITER) // Global/default role
  status   UserStatus @default(ACTIVE)

  // Email verification
  emailVerified      Boolean   @default(false)
  verificationToken  String?   @unique
  verificationExpiry DateTime?

  // Invitation system (legacy - kept for backward compatibility)
  invitationToken     String?   @unique
  invitationExpiresAt DateTime?

  // Team integration
  teamIds String[] @default([])

  // Two-Factor Authentication
  twoFactorEnabled Boolean  @default(false)
  twoFactorSecret  String?  // Encrypted TOTP secret
  recoveryCodes    String[] @default([]) // Hashed one-time recovery codes

  // Timezone preference for scheduling
  timezone         String?  // IANA timezone like "Asia/Kolkata"

  lastLogin DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  teams           Team[]          @relation("UserTeams")
  teamMemberships TeamMember[]    @relation("TeamMemberships")
  auditLogs       AuditLog[]
  refreshTokens   RefreshToken[]
  userTenants     UserTenant[]
  passwordResets  PasswordReset[]
  candidateNotes  CandidateNote[] @relation("CandidateNoteAuthor")
  interviewNotes  InterviewNote[] @relation("InterviewNoteAuthor")
  customRoles     UserCustomRole[]

  @@index([tenantId, status])
  @@index([email])
}

model Team {
  id          String       @id @default(cuid())
  tenantId    String
  tenant      Tenant       @relation(fields: [tenantId], references: [id])
  name        String
  description String?
  leadId      String? // User acting as Team Lead
  users       User[]       @relation("UserTeams")
  members     TeamMember[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
}

model TeamMember {
  id        String   @id @default(cuid())
  tenantId  String
  teamId    String
  userId    String
  role      String? // 'TEAM_LEAD' or 'TEAM_MEMBER' override
  createdAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation("TeamMemberships", fields: [userId], references: [id])

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model Candidate {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  email       String?
  phone       String?
  roleTitle   String?
  stage       String
  source      String?
  resumeUrl   String?
  photoUrl    String?  // Profile photo URL (stored in MinIO)
  notes       String?
  tags        String[]
  createdById String?

  // External system tracking for sync
  externalId       String?  // ID in external system (e.g., Zoho record ID)
  externalSource   String?  // External source system (e.g., 'ZOHO_CRM', 'greenhouse')
  rawExternalData  Json?    // Complete raw payload from external system

  overallScore   Float?
  lastFeedbackAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  interviews     Interview[]
  candidateNotes CandidateNote[]
  stageHistory   CandidateStageHistory[]
  opportunityLinks CandidateOpportunity[]  // Links to HubSpot Deals / Salesforce Opportunities
  externalFeedback ExternalFeedbackContext[] // Historical feedback from ATS systems (read-only)
  portalTokens   CandidatePortalToken[]    // Portal access tokens

  @@unique([tenantId, externalId, externalSource], name: "unique_external_candidate")
  @@index([tenantId, createdAt], name: "idx_candidate_tenant_created")
  @@index([tenantId, externalId], name: "idx_candidate_external")
}

// Secure portal access tokens for candidates to view their application status
model CandidatePortalToken {
  id          String    @id @default(cuid())
  tenantId    String
  candidateId String
  tokenHash   String    @unique
  expiresAt   DateTime
  lastUsedAt  DateTime?
  createdAt   DateTime  @default(now())
  revokedAt   DateTime?

  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@index([tokenHash])
  @@index([tenantId, expiresAt])
}

// Track all candidate stage transitions for audit trail
model CandidateStageHistory {
  id            String   @id @default(cuid())
  tenantId      String
  candidateId   String
  previousStage String
  newStage      String
  source        String   // 'SYSTEM' | 'USER'
  triggeredBy   String   // 'INTERVIEW_SCHEDULED', 'MANUAL', 'BULK_SCHEDULE', etc.
  actorId       String?  // User who initiated (null for system)
  reason        String?  // Required for manual/override transitions
  createdAt     DateTime @default(now())

  candidate     Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([tenantId, candidateId])
  @@index([candidateId, createdAt])
}

// Bulk scheduling mode for interview creation
enum BulkMode {
  SEQUENTIAL // One interview per candidate, staggered times
  GROUP      // One interview for all candidates at same time
}

model Interview {
  id             String    @id @default(cuid())
  tenantId       String
  tenant         Tenant    @relation(fields: [tenantId], references: [id])
  candidateId    String
  candidate      Candidate @relation(fields: [candidateId], references: [id])
  interviewerIds String[]
  date           DateTime
  durationMins   Int
  stage          String
  status         String
  meetingLink    String?
  notes          String?

  avgRating   Float?
  hasFeedback Boolean @default(false)
  isNoShow    Boolean @default(false)

  // Bulk scheduling support
  bulkMode     BulkMode? // null for single interviews, SEQUENTIAL or GROUP for bulk
  bulkBatchId  String?   // Links interviews created in same bulk action
  candidateIds String[]  @default([]) // For GROUP mode: multiple candidates in one interview

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  feedbacks      Feedback[]
  interviewNotes InterviewNote[]

  @@index([tenantId, date], name: "idx_interview_tenant_date")
  @@index([candidateId], name: "idx_interview_candidate")
  @@index([bulkBatchId])
}

model Feedback {
  id            String    @id @default(cuid())
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  interviewId   String
  interview     Interview @relation(fields: [interviewId], references: [id])
  interviewerId String
  rating        Int
  criteria      Json?
  comments      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([interviewerId, interviewId]) // Ensure one feedback per interviewer per interview
}

model Integration {
  id           String    @id @default(cuid())
  tenantId     String
  tenant       Tenant    @relation(fields: [tenantId], references: [id])
  provider     String // "zoho", "salesforce", "google_calendar", "outlook_calendar"
  tokens       Json? // encrypted access/refresh tokens
  settings     Json? // mapping, field associations, flags
  status       String? // "connected", "error", "pending", "auth_required"
  instanceUrl  String?  // Salesforce instance URL (e.g., https://na1.salesforce.com)
  lastSyncedAt DateTime?
  lastError    String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([tenantId, provider])
}

// Opportunity/Deal context from CRMs (NOT candidates - stored for interview context only)
// Applies to: Salesforce Opportunities, HubSpot Deals
model OpportunityContext {
  id              String    @id @default(cuid())
  tenantId        String
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Provider-agnostic fields
  provider        String    // 'salesforce' | 'hubspot'
  externalId      String    // External ID (Salesforce Opportunity ID or HubSpot Deal ID)
  name            String
  stageName       String?
  
  // Company/Account info
  accountId       String?   // Salesforce Account ID or HubSpot Company ID
  accountName     String?
  
  // Owner info
  ownerId         String?
  ownerName       String?
  
  // Deal details
  amount          Float?
  closeDate       DateTime?
  probability     Float?
  
  // Associated candidates (many-to-many via join)
  candidateLinks  CandidateOpportunity[]
  
  rawData         Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([tenantId, provider, externalId])
  @@index([tenantId])
  @@index([tenantId, provider])
}

// Many-to-many relationship: Candidates can be linked to multiple Deals/Opportunities
model CandidateOpportunity {
  id                   String             @id @default(cuid())
  candidateId          String
  candidate            Candidate          @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  opportunityContextId String
  opportunityContext   OpportunityContext @relation(fields: [opportunityContextId], references: [id], onDelete: Cascade)
  
  // Association metadata
  associationType      String?            // 'primary' | 'related'
  createdAt            DateTime           @default(now())

  @@unique([candidateId, opportunityContextId])
  @@index([candidateId])
  @@index([opportunityContextId])
}

// External interview feedback from ATS systems (read-only context)
model ExternalFeedbackContext {
  id              String    @id @default(cuid())
  tenantId        String
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  provider        String    // 'greenhouse' | 'lever' | etc
  externalId      String    // External feedback/scorecard ID
  
  candidateId     String
  candidate       Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  
  // Feedback details (read-only reference)
  interviewerName String?
  interviewType   String?   // 'phone_screen' | 'onsite' | etc
  interviewDate   DateTime?
  
  // Scores and comments
  overallScore    String?   // Text representation (varies by ATS)
  scorecard       Json?     // Structured scorecard data
  comments        String?   @db.Text
  recommendation  String?   // 'hire' | 'no_hire' | 'undecided' | etc
  
  rawData         Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([tenantId, provider, externalId])
  @@index([candidateId])
  @@index([tenantId, provider])
}

model AuditLog {
  id        String   @id @default(cuid())
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  action    String
  metadata  Json?
  ip        String?
  createdAt DateTime @default(now())
}

model APIKey {
  id        String    @id @default(cuid())
  tenantId  String
  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  name      String
  hashedKey String
  scopes    String[]
  active    Boolean   @default(true)
  lastUsed  DateTime?
  createdAt DateTime  @default(now())
}

enum Role {
  SUPERADMIN
  SUPPORT
  ADMIN
  MANAGER
  RECRUITER
  INTERVIEWER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  INVITED
  PENDING_ACTIVATION
}

model FileObject {
  id         String    @id @default(cuid())
  tenantId   String
  tenant     Tenant    @relation(fields: [tenantId], references: [id])
  ownerId    String?
  linkedType String? // 'candidate' | 'interview' | 'user'
  linkedId   String?
  key        String // S3 key
  filename   String
  mimeType   String?
  size       Int?
  version    Int       @default(1)
  status     String    @default("active") // active, deleted, quarantined
  scanStatus String    @default("pending") // pending, clean, infected, failed
  metadata   Json?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  @@index([tenantId, linkedType, linkedId])
  @@index([tenantId, status])
  @@index([tenantId, scanStatus])
}

model RefreshToken {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  tokenHash      String
  activeTenantId String? // Track which tenant was active when token was issued
  revoked        Boolean  @default(false)
  revokedReason  String?  // 'password_change', 'role_change', 'logout', 'admin_revoke', 'user_deactivated'
  expiresAt      DateTime
  userAgent      String? // For session tracking
  ipAddress      String? // For session tracking
  deviceName     String? // User-friendly device name
  lastUsedAt     DateTime? // Last time this token was used for refresh
  createdAt      DateTime @default(now())

  @@index([userId, revoked])
}

// ============================================
// MULTI-TENANT AUTH MODELS
// ============================================

// UserTenant: Join table for multi-tenant user membership
model UserTenant {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenantId  String
  tenant    Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  role      Role             @default(RECRUITER)
  status    UserTenantStatus @default(ACTIVE)
  invitedBy String?
  invitedAt DateTime?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@index([userId])
}

enum UserTenantStatus {
  ACTIVE
  INACTIVE
  PENDING
}

// Invitation: For invite-based onboarding
model Invitation {
  id        String    @id @default(cuid())
  tenantId  String
  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  email     String
  role      Role      @default(RECRUITER)
  tokenHash String    @unique
  expiresAt DateTime
  createdBy String?
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([tenantId])
  @@index([email])
}

// PasswordReset: For password reset flow
model PasswordReset {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
}

// ============================================
// COMMUNICATION MODULE MODELS
// ============================================

model ChannelConfig {
  id           String    @id @default(cuid())
  tenantId     String
  tenant       Tenant    @relation(fields: [tenantId], references: [id])
  channel      Channel
  provider     String // smtp, ses, whatsapp_cloud, twilio
  credentials  Json // Encrypted: host, port, apiKey, etc.
  settings     Json? // from address, business name, etc.
  isActive     Boolean   @default(true)
  isVerified   Boolean   @default(false)
  lastTestedAt DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([tenantId, channel])
  @@index([tenantId])
}

model MessageTemplate {
  id          String           @id @default(cuid())
  tenantId    String
  tenant      Tenant           @relation(fields: [tenantId], references: [id])
  name        String
  channel     Channel
  category    TemplateCategory
  subject     String? // For email
  body        String // HTML for email, text with {{vars}} for WhatsApp/SMS
  variables   String[] // ["candidate.name", "interview.date", ...]
  isSystem    Boolean          @default(false) // System templates can't be deleted
  isActive    Boolean          @default(true)
  version     Int              @default(1)
  createdById String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  automationRules AutomationRule[]

  @@unique([tenantId, name, channel, version]) // Versioning constraint
  @@index([tenantId, category])
}

model AutomationRule {
  id          String            @id @default(cuid())
  tenantId    String
  tenant      Tenant            @relation(fields: [tenantId], references: [id])
  name        String
  trigger     AutomationTrigger
  conditions  Json? // Optional conditions: stage, role, etc.
  
  // Action details
  actionType  AutomationActionType @default(SEND_COMMUNICATION)
  actionData  Json?               // For stage updates: { "stage": "REJECTED" }
  
  // Communication specific (can be null for other actions)
  channel     Channel?
  templateId  String?
  template    MessageTemplate?   @relation(fields: [templateId], references: [id])
  delay       Int               @default(0) // Minutes after trigger (negative = before)

  isActive    Boolean           @default(true)
  createdById String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([tenantId, isActive])
}

model MessageLog {
  id             String        @id @default(cuid())
  tenantId       String
  tenant         Tenant        @relation(fields: [tenantId], references: [id])
  channel        Channel
  templateId     String?
  recipientType  RecipientType // CANDIDATE, INTERVIEWER, USER
  recipientId    String // candidateId, userId, etc.
  recipientEmail String?
  recipientPhone String?
  subject        String?
  body           String
  status         MessageStatus @default(PENDING)
  externalId     String? // Provider message ID
  metadata       Json? // Error details, delivery info
  scheduledFor   DateTime?
  sentAt         DateTime?
  deliveredAt    DateTime?
  readAt         DateTime?
  failedAt       DateTime?
  retryCount     Int           @default(0)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([tenantId, status])
  @@index([tenantId, channel, createdAt])
  @@index([tenantId, recipientId])
  @@index([externalId])
}

model ScheduledMessage {
  id            String         @id @default(cuid())
  tenantId      String
  tenant        Tenant         @relation(fields: [tenantId], references: [id])
  channel       Channel
  templateId    String?
  recipientType RecipientType
  recipientId   String
  payload       Json // Full message payload
  scheduledFor  DateTime
  status        ScheduleStatus @default(PENDING)
  jobId         String? // BullMQ job ID
  createdById   String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([tenantId, scheduledFor, status])
}

// Communication Enums
enum Channel {
  EMAIL
  WHATSAPP
  SMS
}

enum AutomationActionType {
  SEND_COMMUNICATION
  UPDATE_STAGE
  // Future: ASSIGN_TASK, CREATE_NOTE, INTEGRATION_SYNC
}

enum TemplateCategory {
  INTERVIEW_SCHEDULED
  INTERVIEW_REMINDER
  INTERVIEW_RESCHEDULED
  INTERVIEW_CANCELLED
  FEEDBACK_REQUEST
  OFFER_LETTER
  WELCOME
  CUSTOM
}

enum AutomationTrigger {
  INTERVIEW_SCHEDULED
  INTERVIEW_REMINDER_24H
  INTERVIEW_REMINDER_1H
  INTERVIEW_RESCHEDULED
  INTERVIEW_CANCELLED
  INTERVIEW_COMPLETED
  INTERVIEW_NO_SHOW
  FEEDBACK_SUBMITTED
  CANDIDATE_STAGE_CHANGED
  OFFER_EXTENDED
}

enum MessageStatus {
  PENDING
  QUEUED
  SENT
  DELIVERED
  READ
  FAILED
  BOUNCED
}

enum RecipientType {
  CANDIDATE
  INTERVIEWER
  USER
  EXTERNAL
}

enum ScheduleStatus {
  PENDING
  SENT
  CANCELLED
  FAILED
}

// ============================================
// Calendar / Scheduling Module
// ============================================

model WorkingHours {
  id            String    @id @default(cuid())
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  userId        String    // interviewer's User.id
  weekly        Json      // [{dow:0, start:"09:00", end:"17:00"}, ...]
  timezone      String    // IANA timezone like "Asia/Kolkata"
  effectiveFrom DateTime?
  effectiveTo   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([tenantId, userId])
}

model BusyBlock {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  userId    String
  startAt   DateTime
  endAt     DateTime
  reason    String?
  source    String   // 'manual' | 'calendar_sync' | 'interview'
  sourceId  String?  // Reference to interview/external event ID
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, userId, startAt, endAt])
}

model SchedulingRule {
  id               String   @id @default(cuid())
  tenantId         String
  tenant           Tenant   @relation(fields: [tenantId], references: [id])
  name             String
  minNoticeMins    Int      @default(60)
  bufferBeforeMins Int      @default(10)
  bufferAfterMins  Int      @default(10)
  defaultSlotMins  Int      @default(60)
  allowOverlapping Boolean  @default(false)
  isDefault        Boolean  @default(false)
  createdBy        String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([tenantId])
}

model InterviewSlot {
  id           String    @id @default(cuid())
  tenantId     String
  tenant       Tenant    @relation(fields: [tenantId], references: [id])
  interviewId  String?   // Link to Interview if booked
  organizerId  String?   // User who created the slot
  participants Json      // [{type:'user', id:'...'}, {type:'candidate', id:'...'}]
  startAt      DateTime
  endAt        DateTime
  timezone     String
  status       SlotStatus @default(AVAILABLE)
  metadata     Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([tenantId, startAt, status])
}

model CalendarSyncAccount {
  id                String    @id @default(cuid())
  tenantId          String
  tenant            Tenant    @relation(fields: [tenantId], references: [id])
  userId            String
  provider          String    // 'google' | 'microsoft'
  providerAccountId String
  credentials       Json      // Encrypted OAuth tokens
  lastSyncAt        DateTime?
  syncEnabled       Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([tenantId, userId])
  @@unique([tenantId, userId, provider])
}

enum SlotStatus {
  AVAILABLE
  BOOKED
  CANCELLED
  EXPIRED
}

// ============================================
// REPORTS MODULE MODELS
// ============================================

model ScheduledReport {
  id          String   @id @default(cuid())
  tenantId    String
  createdById String
  reportType  String   // 'overview', 'funnel', 'time-to-hire', etc.
  frequency   String   // 'daily', 'weekly', 'monthly'
  recipients  String[] // Email addresses
  dayOfWeek   Int?     // 0-6 for weekly
  dayOfMonth  Int?     // 1-28 for monthly
  time        String   // HH:mm format
  name        String?
  isActive    Boolean  @default(true)
  lastRunAt   DateTime?
  nextRunAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId, isActive])
  @@index([nextRunAt, isActive])
}
// Recycle Bin for soft deletes with role-based access
model RecycleBinItem {
  id           String    @id @default(cuid())
  tenantId     String
  module       String    // 'candidate', 'interview', 'file', 'template'
  itemId       String    // Original resource ID
  itemSnapshot Json      // Full copy of item at deletion time
  deletedBy    String    // User ID who deleted it (required for role-based access)
  deletedAt    DateTime  @default(now())
  restoredAt   DateTime? // Set when item is restored
  purgedAt     DateTime? // Set when item is permanently deleted
  expiresAt    DateTime? // Auto-purge date (30 days default)

  @@index([tenantId])
  @@index([deletedBy])
  @@index([module])
  @@index([tenantId, deletedBy])
}

// SSO Provider Types
enum SSOProviderType {
  SAML
  GOOGLE
  MICROSOFT
}

// Identity Provider configuration for multi-tenant SSO
model IdentityProvider {
  id        String          @id @default(cuid())
  tenantId  String
  tenant    Tenant          @relation(fields: [tenantId], references: [id])
  
  providerType      SSOProviderType
  
  // OAuth credentials (for Google/Microsoft)
  clientId          String?
  clientSecret      String?
  redirectUri       String?
  
  // Domain restriction (e.g., 'acme.com')
  domainRestriction String?
  
  // SAML configuration
  samlMetadataUrl   String?
  samlEntityId      String?
  samlCertificate   String?   @db.Text
  samlAcsUrl        String?   // Assertion Consumer Service URL
  samlSsoUrl        String?   // Single Sign-On URL
  samlLogoutUrl     String?
  
  // Behavior settings
  autoProvision     Boolean   @default(false)
  enabled           Boolean   @default(false)
  
  // Audit fields
  createdById       String?
  updatedById       String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@unique([tenantId, providerType])
  @@index([tenantId])
  @@index([providerType])
}

// ============================================
// NOTES MODULE MODELS
// ============================================

// Candidate notes - multiple notes per candidate with author tracking
model CandidateNote {
  id          String    @id @default(cuid())
  tenantId    String
  candidateId String
  authorId    String
  content     String    @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Foreign key relations with cascade delete
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  author      User      @relation("CandidateNoteAuthor", fields: [authorId], references: [id])

  @@index([tenantId, candidateId])
  @@index([authorId])
}

// Interview notes - notes/comments on interviews with author tracking
model InterviewNote {
  id          String    @id @default(cuid())
  tenantId    String
  interviewId String
  authorId    String
  content     String    @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Foreign key relations with cascade delete
  interview   Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  author      User      @relation("InterviewNoteAuthor", fields: [authorId], references: [id])

  @@index([tenantId, interviewId])
  @@index([authorId])
}

// ============================================
// INTEGRATION FIELD MAPPINGS
// ============================================

// Custom field mappings for integration data sync
model FieldMapping {
  id              String   @id @default(cuid())
  tenantId        String
  integrationId   String
  provider        String   // zoho, salesforce, hubspot
  externalField   String   // Field name in external system
  internalField   String   // Field name in Lineup (e.g., 'name', 'email', 'phone')
  dataType        String   // text, email, phone, date, number
  transform       String?  // Optional transform: uppercase, lowercase, trim
  isRequired      Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([tenantId, integrationId, externalField])
  @@index([tenantId, provider])
}

// ============================================
// INTEGRATION SYNC LOGS
// ============================================


// Tracks individual sync attempts for auditability
model IntegrationSyncLog {
  id            String              @id @default(cuid())
  tenantId      String
  provider      String              // zoho, google_calendar, etc.
  eventType     String              // CANDIDATE_CREATED, INTERVIEW_SCHEDULED, etc.
  direction     SyncDirection       // OUTBOUND (Lineup→External) or INBOUND
  entityType    String              // CANDIDATE, INTERVIEW, JOB
  entityId      String?             // ID of the entity being synced
  externalId    String?             // ID in the external system
  payload       Json?               // Request payload sent
  response      Json?               // Response received
  status        SyncLogStatus       @default(PENDING)
  errorMessage  String?             @db.Text
  retryCount    Int                 @default(0)
  createdAt     DateTime            @default(now())
  completedAt   DateTime?

  @@index([tenantId, provider])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@index([entityType, entityId])
}

enum SyncDirection {
  OUTBOUND    // Lineup → External system
  INBOUND     // External system → Lineup
}

enum SyncLogStatus {
  PENDING
  IN_PROGRESS
  SUCCESS
  FAILED
  RETRYING
}

// ============================================
// INTEGRATION ENTITY MAPPINGS
// ============================================

// Maps Lineup entities to external system IDs
model IntegrationMapping {
  id          String   @id @default(cuid())
  tenantId    String
  provider    String   // zoho, salesforce, hubspot
  entityType  String   // candidate, interview, job
  entityId    String   // Lineup entity ID
  externalId  String   // External system ID
  metadata    Json?    // Additional mapping data
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, provider, entityType, entityId])
  @@index([tenantId, provider])
  @@index([externalId])
}

// ===========================================
// CUSTOM ROLES & PERMISSIONS
// ===========================================

enum PermissionLevel {
  SYSTEM  // Platform-only (not assignable by tenants)
  TENANT  // Assignable by tenant admins
}

enum RoleType {
  SYSTEM  // Built-in roles (ADMIN, MANAGER, etc.)
  CUSTOM  // Tenant-created roles
}

model Permission {
  id          String          @id
  category    String          // e.g., "candidates", "interviews", "reports"
  description String
  level       PermissionLevel @default(TENANT)
  createdAt   DateTime        @default(now())

  @@index([category])
  @@index([level])
}

model CustomRole {
  id          String    @id @default(cuid())
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  name        String
  description String?
  type        RoleType  @default(CUSTOM)
  permissions String[]  // Array of Permission IDs
  isDefault   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdById String?

  userRoles   UserCustomRole[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model UserCustomRole {
  id        String     @id @default(cuid())
  userId    String
  user      User       @relation(fields: [userId], references: [id])
  roleId    String
  role      CustomRole @relation(fields: [roleId], references: [id])
  tenantId  String
  createdAt DateTime   @default(now())

  @@unique([userId, roleId, tenantId])
  @@index([userId])
  @@index([roleId])
  @@index([tenantId])
}

// ============================================
// SYSTEM STATUS / HEALTH MONITORING
// ============================================

model SystemComponent {
  id           String   @id @default(cuid())
  key          String   @unique  // 'api', 'database', 'redis', 'calendar', etc.
  name         String   // Display name: "API Server"
  description  String?
  category     String?  // 'core', 'integration', 'communication'
  order        Int      @default(0)  // Display order
  isMonitored  Boolean  @default(true)
  
  // Manual status override (null = use calculated status)
  statusOverride    ComponentStatus?
  statusOverrideBy  String?
  statusOverrideAt  DateTime?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  healthChecks HealthCheckResult[]
  incidents    IncidentComponent[]

  @@index([isMonitored])
}

model HealthCheckResult {
  id            String    @id @default(cuid())
  componentId   String
  component     SystemComponent @relation(fields: [componentId], references: [id], onDelete: Cascade)
  
  status        ComponentStatus  // OPERATIONAL, DEGRADED, PARTIAL_OUTAGE, MAJOR_OUTAGE
  latencyMs     Int?             // Response time if applicable
  message       String?          // Error message or details
  metadata      Json?            // Additional check-specific data
  
  checkedAt     DateTime @default(now())

  @@index([componentId, checkedAt])
  @@index([checkedAt])
}

enum ComponentStatus {
  OPERATIONAL
  DEGRADED
  PARTIAL_OUTAGE
  MAJOR_OUTAGE
  MAINTENANCE
}

model Incident {
  id           String          @id @default(cuid())
  title        String
  status       IncidentStatus  @default(INVESTIGATING)
  severity     IncidentSeverity @default(MINOR)
  
  startedAt    DateTime        @default(now())
  resolvedAt   DateTime?
  
  createdById  String?         // Admin who created it
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  components   IncidentComponent[]
  updates      IncidentUpdate[]

  @@index([status, startedAt])
  @@index([startedAt])
}

model IncidentComponent {
  id           String          @id @default(cuid())
  incidentId   String
  incident     Incident        @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  componentId  String
  component    SystemComponent @relation(fields: [componentId], references: [id], onDelete: Cascade)
  impactLevel  ComponentStatus // How this component is affected

  @@unique([incidentId, componentId])
  @@index([componentId])
}

model IncidentUpdate {
  id           String          @id @default(cuid())
  incidentId   String
  incident     Incident        @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  
  status       IncidentStatus
  message      String          @db.Text
  createdById  String?
  createdAt    DateTime        @default(now())

  @@index([incidentId, createdAt])
}

enum IncidentStatus {
  INVESTIGATING
  IDENTIFIED
  MONITORING
  RESOLVED
}

enum IncidentSeverity {
  MINOR       // Minimal impact
  MAJOR       // Significant impact
  CRITICAL    // System-wide outage
}

// ============================================
// PENDING APPROVALS / OPERATIONS GOVERNANCE
// ============================================

model ApprovalRequest {
  id                   String             @id @default(cuid())
  tenantId             String
  entityType           ApprovalEntityType @default(CANDIDATE)
  
  // Approval workflow
  approvalStatus       ApprovalStatus     @default(PENDING)
  submissionStatus     String?            // "Submission Pending", etc.
  
  // Recruiter info
  recruiterId          String?
  recruiterName        String?
  
  // Candidate/Entity info
  candidateId          String?
  candidateFirstName   String?
  candidateLastName    String?
  candidateEmail       String?
  
  // Job/Interview context
  interviewId          String?
  interviewDate        DateTime?
  clientName           String?
  positionAppliedFor   String?
  
  // Approval tracking
  approvedBy           String?
  approvedAt           DateTime?
  rejectedBy           String?
  rejectedAt           DateTime?
  remarks              String?
  
  // Metadata for extensibility
  metadata             Json?
  
  submittedAt          DateTime           @default(now())
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  @@index([tenantId, approvalStatus])
  @@index([tenantId, submittedAt])
  @@index([tenantId, interviewDate])
}

enum ApprovalEntityType {
  CANDIDATE
  SUBMISSION
  JOB
  OTHER
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============================================
// MANUAL SUBMISSION RUNS (AUDIT LOGGING)
// ============================================

model SubmissionRun {
  id              String    @id @default(cuid())
  tenantId        String
  triggeredBy     String    // User ID who triggered the run
  triggeredAt     DateTime  @default(now())
  totalScanned    Int
  totalSubmitted  Int
  totalSkipped    Int
  errors          Json?     // Array of error objects: { interviewId, reason }
  remarks         String?   // Optional remarks from the user
  completedAt     DateTime?

  @@index([tenantId, triggeredAt])
}

