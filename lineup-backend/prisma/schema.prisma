generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id             String  @id @default(cuid())
  name           String
  domain         String? @unique
  domainVerified Boolean @default(false)
  settings       Json?

  // Branding
  brandingLogoUrl String?
  brandingColors  Json? // { primary: "#xxx", secondary: "#xxx" }

  // Trial
  trialActive Boolean   @default(true)
  trialEndsAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users        User[]
  userTenants  UserTenant[]
  teams        Team[]
  candidates   Candidate[]
  interviews   Interview[]
  feedbacks    Feedback[]
  apiKeys      APIKey[]
  integrations Integration[]
  auditLogs    AuditLog[]
  fileObjects  FileObject[]
  invitations  Invitation[]

  // Communication Module
  channelConfigs    ChannelConfig[]
  messageTemplates  MessageTemplate[]
  automationRules   AutomationRule[]
  messageLogs       MessageLog[]
  scheduledMessages ScheduledMessage[]

  // Calendar / Scheduling Module
  workingHours         WorkingHours[]
  busyBlocks           BusyBlock[]
  schedulingRules      SchedulingRule[]
  interviewSlots       InterviewSlot[]
  calendarSyncAccounts CalendarSyncAccount[]
  securityPolicy       TenantSecurityPolicy?
  
  // SSO / Identity Providers
  identityProviders    IdentityProvider[]
}

// Security policy per tenant for IP allowlist, password policies, etc.
model TenantSecurityPolicy {
  id       String @id @default(cuid())
  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // IP Allowlist
  ipAllowlistEnabled Boolean  @default(false)
  allowedIPs         String[] @default([])

  // Password Policy
  passwordMinLength       Int     @default(8)
  passwordRequireUppercase Boolean @default(true)
  passwordRequireLowercase Boolean @default(true)
  passwordRequireNumber    Boolean @default(true)
  passwordRequireSymbol    Boolean @default(true)
  passwordMaxAgeDays      Int?    // null = no expiry

  // Session Policy
  maxConcurrentSessions Int? // null = unlimited
  sessionTimeoutMinutes Int? // null = use default

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id       String     @id @default(cuid())
  tenantId String? // Legacy: kept for backward compatibility
  tenant   Tenant?    @relation(fields: [tenantId], references: [id])
  email    String     @unique
  password String
  name     String?
  role     Role       @default(RECRUITER) // Global/default role
  status   UserStatus @default(ACTIVE)

  // Email verification
  emailVerified      Boolean   @default(false)
  verificationToken  String?   @unique
  verificationExpiry DateTime?

  // Invitation system (legacy - kept for backward compatibility)
  invitationToken     String?   @unique
  invitationExpiresAt DateTime?

  // Team integration
  teamIds String[] @default([])

  lastLogin DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  teams           Team[]          @relation("UserTeams")
  teamMemberships TeamMember[]    @relation("TeamMemberships")
  auditLogs       AuditLog[]
  refreshTokens   RefreshToken[]
  userTenants     UserTenant[]
  passwordResets  PasswordReset[]

  @@index([tenantId, status])
  @@index([email])
}

model Team {
  id          String       @id @default(cuid())
  tenantId    String
  tenant      Tenant       @relation(fields: [tenantId], references: [id])
  name        String
  description String?
  leadId      String? // User acting as Team Lead
  users       User[]       @relation("UserTeams")
  members     TeamMember[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
}

model TeamMember {
  id        String   @id @default(cuid())
  tenantId  String
  teamId    String
  userId    String
  role      String? // 'TEAM_LEAD' or 'TEAM_MEMBER' override
  createdAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation("TeamMemberships", fields: [userId], references: [id])

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model Candidate {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  email       String?
  phone       String?
  roleTitle   String?
  stage       String
  source      String?
  resumeUrl   String?
  notes       String?
  tags        String[]
  createdById String?

  overallScore   Float?
  lastFeedbackAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  interviews Interview[]

  @@index([tenantId, createdAt], name: "idx_candidate_tenant_created")
}


model Interview {
  id             String    @id @default(cuid())
  tenantId       String
  tenant         Tenant    @relation(fields: [tenantId], references: [id])
  candidateId    String
  candidate      Candidate @relation(fields: [candidateId], references: [id])
  interviewerIds String[]
  date           DateTime
  durationMins   Int
  stage          String
  status         String
  meetingLink    String?
  notes          String?

  avgRating   Float?
  hasFeedback Boolean @default(false)
  isNoShow    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  feedbacks Feedback[]

  @@index([tenantId, date], name: "idx_interview_tenant_date")
  @@index([candidateId], name: "idx_interview_candidate")
}

model Feedback {
  id            String    @id @default(cuid())
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  interviewId   String
  interview     Interview @relation(fields: [interviewId], references: [id])
  interviewerId String
  rating        Int
  criteria      Json?
  comments      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([interviewerId, interviewId]) // Ensure one feedback per interviewer per interview
}

model Integration {
  id           String    @id @default(cuid())
  tenantId     String
  tenant       Tenant    @relation(fields: [tenantId], references: [id])
  provider     String // "zoho", "google_calendar", "outlook_calendar"
  tokens       Json? // encrypted access/refresh tokens
  settings     Json? // mapping, field associations, flags
  status       String? // "connected", "error", "pending"
  lastSyncedAt DateTime?
  lastError    String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([tenantId, provider])
}

model AuditLog {
  id        String   @id @default(cuid())
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  action    String
  metadata  Json?
  ip        String?
  createdAt DateTime @default(now())
}

model APIKey {
  id        String    @id @default(cuid())
  tenantId  String
  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  name      String
  hashedKey String
  scopes    String[]
  active    Boolean   @default(true)
  lastUsed  DateTime?
  createdAt DateTime  @default(now())
}

enum Role {
  SUPERADMIN
  SUPPORT
  ADMIN
  MANAGER
  RECRUITER
  INTERVIEWER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  INVITED
  PENDING_ACTIVATION
}

model FileObject {
  id         String    @id @default(cuid())
  tenantId   String
  tenant     Tenant    @relation(fields: [tenantId], references: [id])
  ownerId    String?
  linkedType String? // 'candidate' | 'interview' | 'user'
  linkedId   String?
  key        String // S3 key
  filename   String
  mimeType   String?
  size       Int?
  version    Int       @default(1)
  status     String    @default("active") // active, deleted, quarantined
  scanStatus String    @default("pending") // pending, clean, infected, failed
  metadata   Json?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  @@index([tenantId, linkedType, linkedId])
  @@index([tenantId, status])
  @@index([tenantId, scanStatus])
}

model RefreshToken {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  tokenHash      String
  activeTenantId String? // Track which tenant was active when token was issued
  revoked        Boolean  @default(false)
  expiresAt      DateTime
  userAgent      String? // For session tracking
  ipAddress      String? // For session tracking
  createdAt      DateTime @default(now())

  @@index([userId, revoked])
}

// ============================================
// MULTI-TENANT AUTH MODELS
// ============================================

// UserTenant: Join table for multi-tenant user membership
model UserTenant {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenantId  String
  tenant    Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  role      Role             @default(RECRUITER)
  status    UserTenantStatus @default(ACTIVE)
  invitedBy String?
  invitedAt DateTime?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@index([userId])
}

enum UserTenantStatus {
  ACTIVE
  INACTIVE
  PENDING
}

// Invitation: For invite-based onboarding
model Invitation {
  id        String    @id @default(cuid())
  tenantId  String
  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  email     String
  role      Role      @default(RECRUITER)
  tokenHash String    @unique
  expiresAt DateTime
  createdBy String?
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([tenantId])
  @@index([email])
}

// PasswordReset: For password reset flow
model PasswordReset {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
}

// ============================================
// COMMUNICATION MODULE MODELS
// ============================================

model ChannelConfig {
  id           String    @id @default(cuid())
  tenantId     String
  tenant       Tenant    @relation(fields: [tenantId], references: [id])
  channel      Channel
  provider     String // smtp, ses, whatsapp_cloud, twilio
  credentials  Json // Encrypted: host, port, apiKey, etc.
  settings     Json? // from address, business name, etc.
  isActive     Boolean   @default(true)
  isVerified   Boolean   @default(false)
  lastTestedAt DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([tenantId, channel])
  @@index([tenantId])
}

model MessageTemplate {
  id          String           @id @default(cuid())
  tenantId    String
  tenant      Tenant           @relation(fields: [tenantId], references: [id])
  name        String
  channel     Channel
  category    TemplateCategory
  subject     String? // For email
  body        String // HTML for email, text with {{vars}} for WhatsApp/SMS
  variables   String[] // ["candidate.name", "interview.date", ...]
  isSystem    Boolean          @default(false) // System templates can't be deleted
  isActive    Boolean          @default(true)
  version     Int              @default(1)
  createdById String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  automationRules AutomationRule[]

  @@unique([tenantId, name, channel, version]) // Versioning constraint
  @@index([tenantId, category])
}

model AutomationRule {
  id          String            @id @default(cuid())
  tenantId    String
  tenant      Tenant            @relation(fields: [tenantId], references: [id])
  name        String
  trigger     AutomationTrigger
  conditions  Json? // Optional conditions: stage, role, etc.
  
  // Action details
  actionType  AutomationActionType @default(SEND_COMMUNICATION)
  actionData  Json?               // For stage updates: { "stage": "REJECTED" }
  
  // Communication specific (can be null for other actions)
  channel     Channel?
  templateId  String?
  template    MessageTemplate?   @relation(fields: [templateId], references: [id])
  delay       Int               @default(0) // Minutes after trigger (negative = before)

  isActive    Boolean           @default(true)
  createdById String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([tenantId, isActive])
}

model MessageLog {
  id             String        @id @default(cuid())
  tenantId       String
  tenant         Tenant        @relation(fields: [tenantId], references: [id])
  channel        Channel
  templateId     String?
  recipientType  RecipientType // CANDIDATE, INTERVIEWER, USER
  recipientId    String // candidateId, userId, etc.
  recipientEmail String?
  recipientPhone String?
  subject        String?
  body           String
  status         MessageStatus @default(PENDING)
  externalId     String? // Provider message ID
  metadata       Json? // Error details, delivery info
  scheduledFor   DateTime?
  sentAt         DateTime?
  deliveredAt    DateTime?
  readAt         DateTime?
  failedAt       DateTime?
  retryCount     Int           @default(0)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([tenantId, status])
  @@index([tenantId, channel, createdAt])
  @@index([tenantId, recipientId])
  @@index([externalId])
}

model ScheduledMessage {
  id            String         @id @default(cuid())
  tenantId      String
  tenant        Tenant         @relation(fields: [tenantId], references: [id])
  channel       Channel
  templateId    String?
  recipientType RecipientType
  recipientId   String
  payload       Json // Full message payload
  scheduledFor  DateTime
  status        ScheduleStatus @default(PENDING)
  jobId         String? // BullMQ job ID
  createdById   String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([tenantId, scheduledFor, status])
}

// Communication Enums
enum Channel {
  EMAIL
  WHATSAPP
  SMS
}

enum AutomationActionType {
  SEND_COMMUNICATION
  UPDATE_STAGE
  // Future: ASSIGN_TASK, CREATE_NOTE, INTEGRATION_SYNC
}

enum TemplateCategory {
  INTERVIEW_SCHEDULED
  INTERVIEW_REMINDER
  INTERVIEW_RESCHEDULED
  INTERVIEW_CANCELLED
  FEEDBACK_REQUEST
  OFFER_LETTER
  WELCOME
  CUSTOM
}

enum AutomationTrigger {
  INTERVIEW_SCHEDULED
  INTERVIEW_REMINDER_24H
  INTERVIEW_REMINDER_1H
  INTERVIEW_RESCHEDULED
  INTERVIEW_CANCELLED
  INTERVIEW_COMPLETED
  INTERVIEW_NO_SHOW
  FEEDBACK_SUBMITTED
  CANDIDATE_STAGE_CHANGED
  OFFER_EXTENDED
}

enum MessageStatus {
  PENDING
  QUEUED
  SENT
  DELIVERED
  READ
  FAILED
  BOUNCED
}

enum RecipientType {
  CANDIDATE
  INTERVIEWER
  USER
  EXTERNAL
}

enum ScheduleStatus {
  PENDING
  SENT
  CANCELLED
  FAILED
}

// ============================================
// Calendar / Scheduling Module
// ============================================

model WorkingHours {
  id            String    @id @default(cuid())
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  userId        String    // interviewer's User.id
  weekly        Json      // [{dow:0, start:"09:00", end:"17:00"}, ...]
  timezone      String    // IANA timezone like "Asia/Kolkata"
  effectiveFrom DateTime?
  effectiveTo   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([tenantId, userId])
}

model BusyBlock {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  userId    String
  startAt   DateTime
  endAt     DateTime
  reason    String?
  source    String   // 'manual' | 'calendar_sync' | 'interview'
  sourceId  String?  // Reference to interview/external event ID
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, userId, startAt, endAt])
}

model SchedulingRule {
  id               String   @id @default(cuid())
  tenantId         String
  tenant           Tenant   @relation(fields: [tenantId], references: [id])
  name             String
  minNoticeMins    Int      @default(60)
  bufferBeforeMins Int      @default(10)
  bufferAfterMins  Int      @default(10)
  defaultSlotMins  Int      @default(60)
  allowOverlapping Boolean  @default(false)
  isDefault        Boolean  @default(false)
  createdBy        String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([tenantId])
}

model InterviewSlot {
  id           String    @id @default(cuid())
  tenantId     String
  tenant       Tenant    @relation(fields: [tenantId], references: [id])
  interviewId  String?   // Link to Interview if booked
  organizerId  String?   // User who created the slot
  participants Json      // [{type:'user', id:'...'}, {type:'candidate', id:'...'}]
  startAt      DateTime
  endAt        DateTime
  timezone     String
  status       SlotStatus @default(AVAILABLE)
  metadata     Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([tenantId, startAt, status])
}

model CalendarSyncAccount {
  id                String    @id @default(cuid())
  tenantId          String
  tenant            Tenant    @relation(fields: [tenantId], references: [id])
  userId            String
  provider          String    // 'google' | 'microsoft'
  providerAccountId String
  credentials       Json      // Encrypted OAuth tokens
  lastSyncAt        DateTime?
  syncEnabled       Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([tenantId, userId])
  @@unique([tenantId, userId, provider])
}

enum SlotStatus {
  AVAILABLE
  BOOKED
  CANCELLED
  EXPIRED
}

// ============================================
// REPORTS MODULE MODELS
// ============================================

model ScheduledReport {
  id          String   @id @default(cuid())
  tenantId    String
  createdById String
  reportType  String   // 'overview', 'funnel', 'time-to-hire', etc.
  frequency   String   // 'daily', 'weekly', 'monthly'
  recipients  String[] // Email addresses
  dayOfWeek   Int?     // 0-6 for weekly
  dayOfMonth  Int?     // 1-28 for monthly
  time        String   // HH:mm format
  name        String?
  isActive    Boolean  @default(true)
  lastRunAt   DateTime?
  nextRunAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId, isActive])
  @@index([nextRunAt, isActive])
}
// Recycle Bin for soft deletes with role-based access
model RecycleBinItem {
  id           String    @id @default(cuid())
  tenantId     String
  module       String    // 'candidate', 'interview', 'file', 'template'
  itemId       String    // Original resource ID
  itemSnapshot Json      // Full copy of item at deletion time
  deletedBy    String    // User ID who deleted it (required for role-based access)
  deletedAt    DateTime  @default(now())
  restoredAt   DateTime? // Set when item is restored
  purgedAt     DateTime? // Set when item is permanently deleted
  expiresAt    DateTime? // Auto-purge date (30 days default)

  @@index([tenantId])
  @@index([deletedBy])
  @@index([module])
  @@index([tenantId, deletedBy])
}

// SSO Provider Types
enum SSOProviderType {
  SAML
  GOOGLE
  MICROSOFT
}

// Identity Provider configuration for multi-tenant SSO
model IdentityProvider {
  id        String          @id @default(cuid())
  tenantId  String
  tenant    Tenant          @relation(fields: [tenantId], references: [id])
  
  providerType      SSOProviderType
  
  // OAuth credentials (for Google/Microsoft)
  clientId          String?
  clientSecret      String?
  redirectUri       String?
  
  // Domain restriction (e.g., 'acme.com')
  domainRestriction String?
  
  // SAML configuration
  samlMetadataUrl   String?
  samlEntityId      String?
  samlCertificate   String?   @db.Text
  samlAcsUrl        String?   // Assertion Consumer Service URL
  samlSsoUrl        String?   // Single Sign-On URL
  samlLogoutUrl     String?
  
  // Behavior settings
  autoProvision     Boolean   @default(false)
  enabled           Boolean   @default(false)
  
  // Audit fields
  createdById       String?
  updatedById       String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@unique([tenantId, providerType])
  @@index([tenantId])
  @@index([providerType])
}
